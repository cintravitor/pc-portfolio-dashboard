<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Executive Metrics</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        h1 { color: #00ff00; text-align: center; }
        h2 { color: #00ffff; border-bottom: 2px solid #00ffff; padding-bottom: 5px; }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #00ff00;
            overflow-x: auto;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #004400; border: 2px solid #00ff00; }
        .error { background: #440000; border: 2px solid #ff0000; color: #ff0000; }
        .info { background: #004444; border: 2px solid #00ffff; color: #00ffff; }
        button {
            background: #004400;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px 5px;
        }
        button:hover { background: #006600; }
        .metric-card {
            background: #000;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .metric-label { color: #00ffff; font-weight: bold; }
        .metric-value { color: #00ff00; font-size: 1.2em; margin-left: 10px; }
    </style>
</head>
<body>
    <h1>üß™ Executive Metrics Test Console</h1>
    
    <div class="status info">
        <strong>Test Purpose:</strong> Verify calculatePortfolioMetrics() function returns correct data structure
    </div>

    <button onclick="runTest()">‚ñ∂Ô∏è Run Test</button>
    <button onclick="location.reload()">üîÑ Reset</button>

    <div id="results"></div>

    <script src="config.js"></script>
    <script src="core/data-manager.js"></script>
    
    <script>
        async function runTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">‚è≥ Running test...</div>';

            try {
                // Step 1: Fetch data
                resultsDiv.innerHTML += '<h2>Step 1: Fetching Portfolio Data</h2>';
                await window.DataManager.fetchSheetData();
                const portfolioData = window.DataManager.getPortfolioData();
                
                resultsDiv.innerHTML += `<div class="status success">‚úÖ Fetched ${portfolioData.length} products</div>`;

                // Step 2: Calculate metrics
                resultsDiv.innerHTML += '<h2>Step 2: Calculating Portfolio Metrics</h2>';
                const metrics = window.DataManager.calculatePortfolioMetrics();

                if (!metrics) {
                    throw new Error('calculatePortfolioMetrics() returned null');
                }

                resultsDiv.innerHTML += '<div class="status success">‚úÖ Metrics calculated successfully</div>';

                // Step 3: Verify structure
                resultsDiv.innerHTML += '<h2>Step 3: Data Structure Verification</h2>';
                
                const expectedKeys = [
                    'healthScore', 'totalProducts', 'productsWithData',
                    'riskBreakdown', 'topRisks', 'avgRiskScore',
                    'topOpportunities', 'avgPerformanceScore',
                    'alignmentByArea', 'allocationByMaturity', 'topOwnersByCount',
                    'productsAtRisk', 'starPerformers', 'needsAttention',
                    'productMetrics'
                ];

                let allKeysPresent = true;
                const missingKeys = [];

                expectedKeys.forEach(key => {
                    if (!(key in metrics)) {
                        allKeysPresent = false;
                        missingKeys.push(key);
                    }
                });

                if (allKeysPresent) {
                    resultsDiv.innerHTML += '<div class="status success">‚úÖ All expected keys present</div>';
                } else {
                    resultsDiv.innerHTML += `<div class="status error">‚ùå Missing keys: ${missingKeys.join(', ')}</div>`;
                }

                // Step 4: Display metrics
                resultsDiv.innerHTML += '<h2>Step 4: Calculated Metrics</h2>';
                
                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>üìä Summary Metrics</h3>';
                resultsDiv.innerHTML += `<div><span class="metric-label">Portfolio Health Score:</span><span class="metric-value">${metrics.healthScore}/100</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Total Products:</span><span class="metric-value">${metrics.totalProducts}</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Products with Data:</span><span class="metric-value">${metrics.productsWithData}</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Avg Performance Score:</span><span class="metric-value">${metrics.avgPerformanceScore}%</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Avg Risk Score:</span><span class="metric-value">${metrics.avgRiskScore}/10</span></div>`;
                resultsDiv.innerHTML += '</div>';

                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>‚ö†Ô∏è Risk Breakdown</h3>';
                resultsDiv.innerHTML += `<div><span class="metric-label">High Risk:</span><span class="metric-value">${metrics.riskBreakdown.high}</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Medium Risk:</span><span class="metric-value">${metrics.riskBreakdown.medium}</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Low Risk:</span><span class="metric-value">${metrics.riskBreakdown.low}</span></div>`;
                resultsDiv.innerHTML += '</div>';

                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>üö® Top 3 Risks</h3>';
                metrics.topRisks.forEach((risk, i) => {
                    resultsDiv.innerHTML += `<div>${i+1}. <span class="metric-label">${risk.name}</span> - Risk Score: <span class="metric-value">${risk.riskScore.toFixed(1)}</span> (${risk.area})</div>`;
                });
                resultsDiv.innerHTML += '</div>';

                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>üåü Top 3 Opportunities</h3>';
                metrics.topOpportunities.forEach((opp, i) => {
                    resultsDiv.innerHTML += `<div>${i+1}. <span class="metric-label">${opp.name}</span> - Performance: <span class="metric-value">${opp.performanceScore}%</span> (${opp.area})</div>`;
                });
                resultsDiv.innerHTML += '</div>';

                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>üéØ Strategic Alignment by Area</h3>';
                Object.entries(metrics.alignmentByArea).forEach(([area, count]) => {
                    resultsDiv.innerHTML += `<div><span class="metric-label">${area}:</span><span class="metric-value">${count} products</span></div>`;
                });
                resultsDiv.innerHTML += '</div>';

                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>üìà Allocation by Maturity</h3>';
                Object.entries(metrics.allocationByMaturity).forEach(([maturity, count]) => {
                    resultsDiv.innerHTML += `<div><span class="metric-label">${maturity}:</span><span class="metric-value">${count} products</span></div>`;
                });
                resultsDiv.innerHTML += '</div>';

                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>üë• Top 5 Owners by Product Count</h3>';
                metrics.topOwnersByCount.forEach((item, i) => {
                    resultsDiv.innerHTML += `<div>${i+1}. <span class="metric-label">${item.owner}:</span><span class="metric-value">${item.count} products</span></div>`;
                });
                resultsDiv.innerHTML += '</div>';

                resultsDiv.innerHTML += '<div class="metric-card">';
                resultsDiv.innerHTML += '<h3>üí° Additional Insights</h3>';
                resultsDiv.innerHTML += `<div><span class="metric-label">Products at Risk (High risk + Low performance):</span><span class="metric-value">${metrics.productsAtRisk}</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Star Performers (Low risk + High performance):</span><span class="metric-value">${metrics.starPerformers}</span></div>`;
                resultsDiv.innerHTML += `<div><span class="metric-label">Needs Attention (Medium-high risk):</span><span class="metric-value">${metrics.needsAttention}</span></div>`;
                resultsDiv.innerHTML += '</div>';

                // Step 5: Show full JSON
                resultsDiv.innerHTML += '<h2>Step 5: Full JSON Structure</h2>';
                resultsDiv.innerHTML += '<pre>' + JSON.stringify(metrics, null, 2) + '</pre>';

                resultsDiv.innerHTML += '<div class="status success"><strong>üéâ TEST PASSED</strong> - Function works correctly and returns expected structure!</div>';

            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå TEST FAILED: ${error.message}</div>`;
                resultsDiv.innerHTML += '<pre>' + error.stack + '</pre>';
                console.error('Test error:', error);
            }
        }
    </script>
</body>
</html>

